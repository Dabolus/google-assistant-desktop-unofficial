# global default
container:
  image: node:10-alpine

task:
  name: Lint
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat yarn.lock
    populate_script: yarn install
  lint_script: yarn lint

task:
  name: Test
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat yarn.lock
    populate_script: yarn install
  lint_script: yarn test

task:
  name: Linux build
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat yarn.lock
    populate_script: yarn install
  build_script: yarn build

task:
  name: Windows build
  windows_container:
    image: cirrusci/windowsservercore:2016
  depends_on:
    - Lint
    - Test
  yarn_install_script:
    - powershell -Command "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest https://yarnpkg.com/latest.msi -OutFile $env:TEMP\yarn.msi"
    - msiexec /i "%TEMP%\yarn.msi" /quiet
  node_modules_cache:
    folder: node_modules
    fingerprint_script: type yarn.lock
    populate_script: yarn install
  build_script: yarn build

task:
  name: macOS build
  osx_instance:
    image: mojave-base
  env:
    HOMEBREW_NO_AUTO_UPDATE: 1
  yarn_install_script:
    - brew install yarn
    - brew link --force yarn
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat yarn.lock
    populate_script: yarn install
  build_script: yarn build

task:
  name: Publish
  depends_on:
    - Linux build
    - Windows build
    - macOS build
  only_if: $BRANCH == "master"
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat yarn.lock
    populate_script: yarn install
  publish_script: echo "Publish!"
